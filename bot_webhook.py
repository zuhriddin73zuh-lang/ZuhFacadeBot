# -*- coding: utf-8 -*-
import os
import time
import json
import logging
from datetime import datetime
from typing import Optional

import telebot
from telebot import types
from flask import Flask, request, abort

# -------- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è --------
logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s: %(message)s")
log = logging.getLogger(__name__)

# -------- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Render) --------
TOKEN = os.getenv("TELEGRAM_TOKEN")
GROUP_ID_RAW = os.getenv("GROUP_ID")  # –æ–∂–∏–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é -100...
STORAGE_FILE = os.getenv("APPLICATIONS_FILE", "applications.json")  # –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å

if not TOKEN:
    log.error("TELEGRAM_TOKEN –Ω–µ –∑–∞–¥–∞–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_TOKEN.")
    raise SystemExit(1)

if not GROUP_ID_RAW:
    log.error("GROUP_ID –Ω–µ –∑–∞–¥–∞–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è GROUP_ID.")
    raise SystemExit(1)

try:
    GROUP_ID = int(GROUP_ID_RAW)
except ValueError:
    log.error("GROUP_ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä -1001234567890). –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: %s", GROUP_ID_RAW)
    raise SystemExit(1)

bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# -------- –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ --------
user_state = {}   # chat_id -> {"lang": "ru"/"uz", "step": int}
user_data = {}    # chat_id -> list of answers (index order)

# -------- –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã --------
QUESTIONS = {
    "ru": [
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è:",
        "–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å (—É–ª–∏—Ü–∞, –¥–æ–º/–∫–≤):",
        "–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):",
        "–°–∫–æ–ª—å–∫–æ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤? (–ø—Ä–∏–º–µ—Ä: 120 –∏–ª–∏ 120.5):",
        "–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ):"
    ],
    "uz": [
        "Assalomu alaykum! Iltimos, ismingizni kiriting:",
        "Manzilingizni yozing (ko'cha, uy/xona):",
        "Telefon raqamingiz (majburiy):",
        "Necha kvadrat? (masalan: 120 yoki 120.5):",
        "Izohni qoldiring (matn yoki rasm):"
    ]
}

THANK_YOU = {
    "ru": "‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞, –º—ã –≤–∞–º —Å–∫–æ—Ä–æ –ø–æ–∑–≤–æ–Ω–∏–º.",
    "uz": "‚úÖ Rahmat! So'rovingiz qabul qilindi, tez orada sizga qo'ng'iroq qilamiz."
}

# -------- –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞—è–≤–æ–∫ (—Ñ–∞–π–ª) --------
def load_applications():
    try:
        if os.path.exists(STORAGE_FILE):
            with open(STORAGE_FILE, "r", encoding="utf-8") as f:
                return json.load(f)
        return {}
    except Exception as e:
        log.exception("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è storage file: %s", e)
        return {}

def save_applications(data):
    try:
        with open(STORAGE_FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception as e:
        log.exception("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ storage file: %s", e)

applications = load_applications()  # dict app_id -> application dict

def store_application(chat_id: int, lang: str, answers: list):
    app_id = f"{chat_id}_{int(time.time())}"
    entry = {
        "id": app_id,
        "chat_id": chat_id,
        "lang": lang,
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "answers": answers
    }
    applications[app_id] = entry
    save_applications(applications)
    return app_id

# -------- –£—Ç–∏–ª–∏—Ç—ã --------
def parse_start_param(text: str) -> Optional[str]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —è–∑—ã–∫–æ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ /start ..."""
    if not text:
        return None
    parts = text.split(maxsplit=1)
    param = ""
    if len(parts) > 1:
        param = parts[1].strip().lower()
    # –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: "go_uz", "go-uz", "uz", "ru", "start=uz"
    if param.startswith("start="):
        param = param.split("=", 1)[1]
    param = param.replace("-", "_")
    if param.startswith("go_"):
        param = param[3:]
    # –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
    if param in ("uz", "uzbek", "o'zbek", "o‚Äòzbek", "oz"):
        return "uz"
    if param in ("ru", "rus", "russian"):
        return "ru"
    return None

def is_valid_phone(s: str) -> bool:
    sdigits = "".join(ch for ch in s if ch.isdigit())
    return len(sdigits) >= 7  # –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

def safe_send_message(chat_id, text, **kwargs):
    try:
        return bot.send_message(chat_id, text, **kwargs)
    except Exception as e:
        log.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è %s: %s", chat_id, e)

# -------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ --------

@bot.message_handler(commands=['start'])
def handle_start(message):
    chat_id = message.chat.id
    text = message.text or ""
    lang = parse_start_param(text)
    if lang is None:
        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä—É—Å—Å–∫–∏–π, –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å
        lang = "ru"
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    user_state[chat_id] = {"lang": lang, "step": 0}
    user_data[chat_id] = []
    log.info("START from %s lang=%s", chat_id, lang)
    safe_send_message(chat_id, QUESTIONS[lang][0])

@bot.message_handler(func=lambda m: m.chat.id in user_state, content_types=['text', 'photo', 'document', 'sticker', 'video', 'audio'])
def handle_steps(message):
    chat_id = message.chat.id
    state = user_state.get(chat_id)
    if not state:
        return  # –Ω–µ—á–µ–≥–æ –¥–µ–ª–∞—Ç—å

    lang = state["lang"]
    step = state["step"]
    q_count = len(QUESTIONS[lang])

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
    if step < 3:  # –®–∞–≥–∏ 0, 1, 2 (–ò–º—è, –ê–¥—Ä–µ—Å, –¢–µ–ª–µ—Ñ–æ–Ω) –æ–∂–∏–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        if message.content_type != 'text':
            safe_send_message(chat_id, "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—á–∞–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–º." if lang == "ru" else "‚ö†Ô∏è Iltimos, javobni matn ko'rinishida yuboring.")
            return

        text = message.text.strip()
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª—è —à–∞–≥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (step=2)
        if step == 2 and not is_valid_phone(text):
            safe_send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–º–∏–Ω–∏–º—É–º 7 —Ü–∏—Ñ—Ä)." if lang == "ru" else "Iltimos, to'g'ri telefon raqamini kiriting (kamida 7 raqam).")
            return

        user_data[chat_id].append(text)
        state["step"] += 1

    elif step == 3:  # –®–∞–≥ 3 (–ü–ª–æ—â–∞–¥—å) –æ–∂–∏–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç
        if message.content_type != 'text':
            safe_send_message(chat_id, "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø–ª–æ—â–∞–¥—å —á–∏—Å–ª–æ–º." if lang == "ru" else "‚ö†Ô∏è Iltimos, maydonni raqamda yuboring.")
            return
        user_data[chat_id].append(message.text.strip())
        state["step"] += 1
        # –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–æ—â–∞–¥–∏ —Å—Ä–∞–∑—É –∑–∞–¥–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        safe_send_message(chat_id, QUESTIONS[lang][4])
        return  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ

    elif step == 4:  # –®–∞–≥ 4 (–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π) –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        if message.content_type == 'text':
            user_data[chat_id].append({"type": "text", "value": message.text.strip()})
        elif message.content_type == 'photo':
            file_id = message.photo[-1].file_id
            user_data[chat_id].append({"type": "photo", "file_id": file_id})
        elif message.content_type == 'document':
            file_id = message.document.file_id
            user_data[chat_id].append({"type": "document", "file_id": file_id, "file_name": getattr(message.document, 'file_name', None)})
        else:
            user_data[chat_id].append({"type": message.content_type, "value": "<non-text data>"})
        state["step"] += 1
    else:
        # –ï—Å–ª–∏ —à–∞–≥ –∫–∞–∫–æ–π-—Ç–æ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π, –æ—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        user_state.pop(chat_id, None)
        user_data.pop(chat_id, None)
        return

    # –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å –∏ —à–∞–≥ —Å—Ç–∞–ª —Ä–∞–≤–µ–Ω 4, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –ø–ª–æ—â–∞–¥—å –∏ –Ω—É–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å –ø—Ä–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    if state["step"] == 4:
        safe_send_message(chat_id, QUESTIONS[lang][4])
        return

    # –ï—Å–ª–∏ —à–∞–≥ —Å—Ç–∞–ª —Ä–∞–≤–µ–Ω 5, –∑–Ω–∞—á–∏—Ç, —Å–æ–±—Ä–∞–ª–∏ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã (–≤–∫–ª—é—á–∞—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
    if state["step"] == 5:
        answers = user_data.get(chat_id, [])
        if len(answers) < 5:
            safe_send_message(chat_id, "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å–Ω–æ–≤–∞ —Å /start." if lang == "ru" else "Nimadir noto'g'ri ketdi. Iltimos, /start buyrug'i bilan qayta boshlang.")
            user_state.pop(chat_id, None)
            user_data.pop(chat_id, None)
            return

        name, address, phone, square, comment = answers[0], answers[1], answers[2], answers[3], answers[4]

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∑–∞—è–≤–∫–∏
        if lang == "ru":
            app_text = (f"üì© –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞\n\nüë§ –ò–º—è: {name}\nüè† –ê–¥—Ä–µ—Å: {address}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: {phone}\nüìê –ö–≤–∞–¥—Ä–∞—Ç–æ–≤: {square}\n")
            user_thanks = THANK_YOU["ru"]
        else:
            app_text = (f"üì© Yangi ariza\n\nüë§ Ism: {name}\nüè† Manzil: {address}\nüìû Telefon: {phone}\nüìê Kvadrat: {square}\n")
            user_thanks = THANK_YOU["uz"]

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –≥—Ä—É–ø–ø—É
        try:
            if isinstance(comment, dict) and comment.get("type") == "photo":
                file_id = comment.get("file_id")
                bot.send_photo(GROUP_ID, file_id, caption=app_text)
            elif isinstance(comment, dict) and comment.get("type") == "document":
                file_id = comment.get("file_id")
                fn = comment.get("file_name") or ""
                caption = app_text + (f"\n–§–∞–π–ª: {fn}" if lang == "ru" else f"\nFayl: {fn}")
                bot.send_document(GROUP_ID, file_id, caption=caption)
            else:
                comment_text = comment.get("value") if isinstance(comment, dict) else str(comment)
                comment_label = "\nüí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: " if lang == "ru" else "\nüí¨ Izoh: "
                full_text = app_text + (comment_label + comment_text if comment_text else "")
                bot.send_message(GROUP_ID, full_text)
        except Exception as e:
            log.exception("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –≤ –≥—Ä—É–ø–ø—É: %s", e)
            try:
                bot.send_message(GROUP_ID, app_text + "\n[–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–ª–æ–∂–µ–Ω–∏–µ]")
            except Exception:
                log.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ fallback –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –≥—Ä—É–ø–ø—É")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –±–ª–∞–≥–æ–¥–∞—Ä–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        store_application(chat_id, lang, answers)
        safe_send_message(chat_id, user_thanks)

        # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        user_state.pop(chat_id, None)
        user_data.pop(chat_id, None)

# -------- Webhook (Flask) - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ß–ê–°–¢–¨ --------
# –í–ê–ñ–ù–û: –ú—ã –¥–æ–ª–∂–Ω—ã –¥–∞—Ç—å telebot –¥–æ—Å—Ç—É–ø –∫ request.get_data() –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
@app.route("/webhook", methods=["POST"])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return ''
    else:
        abort(403)

@app.route("/", methods=["GET"])
def index():
    return "Bot is running. Set webhook to /webhook", 200

# -------- –ó–∞–ø—É—Å–∫ --------
if __name__ == "__main__":
    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤–µ–±—Ö—É–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    bot.remove_webhook()
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ–±—Ö—É–∫ –Ω–∞ –Ω—É–∂–Ω—ã–π URL (–ó–ê–ú–ï–ù–ò–¢E YOUR_RENDER_URL –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π URL)
    # –ù–∞–ø—Ä–∏–º–µ—Ä: https://your-bot-name.onrender.com/webhook
    bot.set_webhook(url="https://zuhfacadebot-1.onrender.com/webhook")
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask app
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))



   

           
        











