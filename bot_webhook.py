import os
import logging
from flask import Flask, request
import telebot

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOKEN = os.getenv('TELEGRAM_TOKEN')
GROUP_ID = int(os.getenv('GROUP_ID', '-1094323262'))  # –≤–∞—à –ª–∏—á–Ω—ã–π ID

bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# –í–æ–ø—Ä–æ—Å—ã –Ω–∞ –¥–≤—É—Ö —è–∑—ã–∫–∞—Ö
QUESTIONS = {
    "ru": [
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à–µ –∏–º—è:",
        "–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞:",
        "–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:",
        "–ü—Ä–∏–º–µ—Ä–Ω–∞—è –∫–≤–∞–¥—Ä–∞—Ç—É—Ä–∞ (–º¬≤):",
        "–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ —Ñ–æ—Ç–æ –¥–æ–º–∞:"
    ],
    "uz": [
        "Assalomu alaykum! Iltimos, ismingizni kiriting:",
        "Obekt manzilini yozing:",
        "Telefon raqamingiz:",
        "Taxminiy maydon (m¬≤):",
        "Izoh yoki uy rasmini yuboring:"
    ]
}

# –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
THANK_YOU = {
    "ru": "‚úÖ –°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
    "uz": "‚úÖ Rahmat! So'rovingiz qabul qilindi. Tez orada siz bilan bog'lanamiz."
}

# –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data = {}

@bot.message_handler(commands=['start'])
def handle_start(message):
    try:
        chat_id = message.chat.id
        text = message.text or ""
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫
        if 'uz' in text:
            lang = 'uz'
        else:
            lang = 'ru'
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_data[chat_id] = {
            'lang': lang,
            'step': 0,
            'answers': []
        }
        
        # –ó–∞–¥–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
        bot.send_message(chat_id, QUESTIONS[lang][0])
        
    except Exception as e:
        logger.error(f"Error in handle_start: {e}")

@bot.message_handler(content_types=['text', 'photo'])
def handle_message(message):
    try:
        chat_id = message.chat.id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∏–∞–ª–æ–≥
        if chat_id not in user_data:
            bot.send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å /start")
            return
        
        user = user_data[chat_id]
        lang = user['lang']
        step = user['step']
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        if step < 4:  # –ü–µ—Ä–≤—ã–µ 4 –≤–æ–ø—Ä–æ—Å–∞ —Ç—Ä–µ–±—É—é—Ç —Ç–µ–∫—Å—Ç
            if message.content_type != 'text':
                bot.send_message(chat_id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ —Ç–µ–∫—Å—Ç–æ–º" if lang == 'ru' else "Iltimos, matn bilan javob bering")
                return
            
            user['answers'].append(message.text)
            user['step'] += 1
            
            # –ó–∞–¥–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
            if user['step'] < 5:
                bot.send_message(chat_id, QUESTIONS[lang][user['step']])
            else:
                # –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã
                send_application(user['answers'], lang, chat_id)
                bot.send_message(chat_id, THANK_YOU[lang])
                del user_data[chat_id]
                
        else:  # 5-–π –≤–æ–ø—Ä–æ—Å (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ —Ñ–æ—Ç–æ)
            if message.content_type == 'photo':
                user['answers'].append("–§–æ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–æ" if lang == 'ru' else "Rasm qo'shildi")
            else:
                user['answers'].append(message.text)
            
            # –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞—è–≤–∫—É
            send_application(user['answers'], lang, chat_id)
            bot.send_message(chat_id, THANK_YOU[lang])
            del user_data[chat_id]
            
    except Exception as e:
        logger.error(f"Error in handle_message: {e}")

def send_application(answers, lang, chat_id):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É –≤ –≥—Ä—É–ø–ø—É"""
    try:
        name, address, phone, square, comment = answers
        
        if lang == 'ru':
            text = f"üìã –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞\n\nüë§ –ò–º—è: {name}\nüè† –ê–¥—Ä–µ—Å: {address}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: {phone}\nüìê –ö–≤–∞–¥—Ä–∞—Ç—É—Ä–∞: {square}\nüí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}"
        else:
            text = f"üìã Yangi ariza\n\nüë§ Ism: {name}\nüè† Manzil: {address}\nüìû Telefon: {phone}\nüìê Maydon: {square}\nüí¨ Izoh: {comment}"
        
        bot.send_message(GROUP_ID, text)
        
    except Exception as e:
        logger.error(f"Error sending application: {e}")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–∞
@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return ''
    return 'Invalid content type', 400

@app.route('/')
def index():
    return 'Bot is running!'

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)

